name: e2e Test on Minikube

on:
  push:
    paths:
      - "application/**"
      - "kubernetes/**"
      - ".github/workflows/minikube-ci.yml"
  pull_request:

jobs:
  minikube:
    runs-on: ubuntu-latest
    steps:
      - name: checkout
        uses: actions/checkout@v1
      - name: setup minikube
        uses: manusa/actions-setup-minikube@v1.0.1
        with:
          minikube version: "v1.5.2"
          kubernetes version: "v1.16.2"
      - name: minikube addon settings
        run: |
          sudo /home/runner/work/_temp/minikube addons enable ingress
          sudo /home/runner/work/_temp/minikube addons list
      - name: apply minimal service
        run: |
          sudo sh ./kubernetes/apply-default-minimal.sh
      - name: check before test
        run: |
          sudo kubectl wait --for=condition=available --timeout=1h deployment/nginx
          sudo kubectl wait --for=condition=Ready --timeout=1h pod/$(sudo kubectl get pods | awk '{print $1}' | grep jaxrs-activemq)
          sudo kubectl get nodes
          sudo kubectl get all
          sudo kubectl get all -n monitoring
          sudo kubectl get ingress
          sudo kubectl logs $(sudo kubectl get pods | awk '{print $1}' | grep jaxrs-activemq)
          sleep 10
          sudo kubectl logs $(sudo kubectl get pods | awk '{print $1}' | grep jaxrs-redis)
          sleep 10
          sudo kubectl top node
      - name: e2e test
        run: |
          sudo kubectl apply -f kubernetes/monitoring/test/postmannewman/postmannewman-job.yaml
          sleep 300
          echo "### postmannewman-job ###"
          sudo kubectl -n monitoring logs -f $(kubectl get pods -n monitoring | awk '{print $1}' | grep postmannewman-job)
          echo "### jaxrs-activemq ###"
          sudo kubectl logs $(kubectl get pods | awk '{print $1}' | grep jaxrs-activemq)
          sleep 10
          echo "### jaxrs-mysql ###"
          sudo kubectl logs $(kubectl get pods | awk '{print $1}' | grep jaxrs-mysql)
          sleep 10
          echo "### jaxrs-postgres ###"
          sudo kubectl logs $(kubectl get pods | awk '{print $1}' | grep jaxrs-postgres)
          sleep 10
          echo "### jaxrs-mongodb ###"
          sudo kubectl logs $(kubectl get pods | awk '{print $1}' | grep jaxrs-mongodb)
          sleep 10
          echo "### jaxrs-redis ###"
          sudo kubectl logs $(kubectl get pods | awk '{print $1}' | grep jaxrs-redis)
          sleep 10
          echo "### jaxrs-redis ###"
          sudo kubectl logs $(kubectl get pods | awk '{print $1}' | grep jaxrs-memcached)
          sleep 10
          echo "### waiting for complete job ... ###"
          sudo kubectl -n monitoring wait --for=condition=complete --timeout=10m job/postmannewman-job
          sudo kubectl -n monitoring describe job postmannewman-job
          sudo kubectl -n monitoring logs $(kubectl get pods -n monitoring | awk '{print $1}' | grep postmannewman-job)
          sudo kubectl get po --all-namespaces=true
